{% extends "base.html" %}

{% block title %}Профиль - ResaleX{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-4">
            <!-- Информация о пользователе -->
            <div class="card shadow-lg border-0 mb-4" style="background: var(--glass-bg); backdrop-filter: var(--glass-backdrop); border: 1px solid var(--glass-border);">
                <div class="card-body text-center p-4">
                    <div class="mb-3">
                        {% if current_user.avatar_url %}
                            <img src="{{ current_user.avatar_url }}" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;" alt="Аватар">
                        {% else %}
                            <div class="rounded-circle bg-gradient d-flex align-items-center justify-content-center mx-auto" style="width: 120px; height: 120px; background: var(--gradient-accent);">
                                <i class="fas fa-user fa-3x text-white"></i>
                            </div>
                        {% endif %}
                    </div>
                    <h4 class="fw-bold mb-1" style="color: var(--text-primary);">{{ current_user.username }}</h4>
                    <p class="text-muted mb-2">{{ current_user.email }}</p>
                    <span class="badge bg-primary">{{ current_user.role.title() }}</span>
                    <div class="mt-3">
                        <a href="{{ url_for('edit_profile') }}" class="btn btn-outline-primary">
                            <i class="fas fa-edit me-2"></i>Редактировать профиль
                        </a>
                    </div>
                </div>
            </div>

            <!-- Статистика -->
            <div class="card shadow-lg border-0" style="background: var(--glass-bg); backdrop-filter: var(--glass-backdrop); border: 1px solid var(--glass-border);">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3" style="color: var(--text-primary);">Статистика</h5>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="mb-0" style="color: var(--text-secondary);">Куплено товаров</h6>
                            <h4 class="fw-bold mb-0" style="color: var(--accent-primary);">{{ orders|length }}</h4>
                        </div>
                        <i class="fas fa-shopping-bag fa-2x" style="color: var(--accent-primary);"></i>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="mb-0" style="color: var(--text-secondary);">Потрачено</h6>
                            <h4 class="fw-bold mb-0" style="color: var(--accent-success);">{{ "%.0f"|format(total_spent) }} ₽</h4>
                        </div>
                        <i class="fas fa-ruble-sign fa-2x" style="color: var(--accent-success);"></i>
                    </div>
                    
                    {% if current_user.role in ['seller', 'admin', 'moderator'] %}
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="mb-0" style="color: var(--text-secondary);">Продано товаров</h6>
                            <h4 class="fw-bold mb-0" style="color: var(--accent-warning);">{{ products|length }}</h4>
                        </div>
                        <i class="fas fa-store fa-2x" style="color: var(--accent-warning);"></i>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0" style="color: var(--text-secondary);">Заработано</h6>
                            <h4 class="fw-bold mb-0" style="color: var(--accent-info);">{{ "%.0f"|format(total_earned) }} ₽</h4>
                        </div>
                        <i class="fas fa-chart-line fa-2x" style="color: var(--accent-info);"></i>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <!-- История покупок -->
            <div class="card shadow-lg border-0 mb-4" style="background: var(--glass-bg); backdrop-filter: var(--glass-backdrop); border: 1px solid var(--glass-border);">
                <div class="card-header" style="background: var(--gradient-glass); border-bottom: 1px solid var(--glass-border);">
                    <h5 class="mb-0 fw-bold" style="color: var(--text-primary);">
                        <i class="fas fa-shopping-cart me-2"></i>История покупок
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if orders %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" style="color: var(--text-primary);">
                            <thead style="background: var(--gradient-glass); color: var(--text-primary);">
                                <tr>
                                    <th>Товар</th>
                                    <th>Цена</th>
                                    <th>Статус</th>
                                    <th>Дата</th>
                                </tr>
                            </thead>
                            <tbody style="color: var(--text-primary);">
                                {% for order in orders %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if order.product.image_url %}
                                            <img src="{{ order.product.image_url }}" class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                            {% else %}
                                            <div class="bg-light rounded me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                <i class="fas fa-image" style="color: var(--text-muted);"></i>
                                            </div>
                                            {% endif %}
                                            <div>
                                                <div class="fw-semibold">{{ order.product.name }}</div>
                                                <small style="color: var(--text-muted);">{{ order.product.brand }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="fw-semibold" style="color: var(--accent-primary);">{{ "%.0f"|format(order.total_amount) }} ₽</td>
                                    <td>
                                        <span class="badge bg-{{ 'warning' if order.status == 'pending' else 'info' if order.status == 'paid' else 'primary' if order.status == 'shipped' else 'success' if order.status == 'delivered' else 'danger' }}">
                                            {{ order.status.title() }}
                                        </span>
                                    </td>
                                    <td>{{ order.created_at.strftime('%d.%m.%Y') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                        <h5 style="color: var(--text-secondary);">Пока нет покупок</h5>
                        <p style="color: var(--text-muted);">Начните покупать товары в нашем магазине!</p>
                        <a href="{{ url_for('index') }}" class="btn btn-primary">Перейти к товарам</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Мои товары (для продавцов) -->
            {% if current_user.role in ['seller', 'admin', 'moderator'] %}
            <div class="card shadow-lg border-0" style="background: var(--glass-bg); backdrop-filter: var(--glass-backdrop); border: 1px solid var(--glass-border);">
                <div class="card-header" style="background: var(--gradient-glass); border-bottom: 1px solid var(--glass-border);">
                    <h5 class="mb-0 fw-bold" style="color: var(--text-primary);">
                        <i class="fas fa-store me-2"></i>Мои товары
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if products %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" style="color: var(--text-primary);">
                            <thead style="background: var(--gradient-glass); color: var(--text-primary);">
                                <tr>
                                    <th>Товар</th>
                                    <th>Цена</th>
                                    <th>Статус</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody style="color: var(--text-primary);">
                                {% for product in products %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if product.image_url %}
                                            <img src="{{ product.image_url }}" class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                            {% else %}
                                            <div class="bg-light rounded me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                <i class="fas fa-image" style="color: var(--text-muted);"></i>
                                            </div>
                                            {% endif %}
                                            <div>
                                                <div class="fw-semibold">{{ product.name }}</div>
                                                <small style="color: var(--text-muted);">{{ product.brand }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="fw-semibold" style="color: var(--accent-primary);">{{ "%.0f"|format(product.price) }} ₽</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if product.status == 'approved' else 'warning' if product.status == 'pending' else 'danger' }}">
                                            {{ product.status.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-outline-warning btn-sm">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('delete_product', product_id=product.id) }}" class="d-inline" 
                                              onsubmit="return confirm('Вы уверены, что хотите удалить этот товар?')">
                                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-store fa-3x text-muted mb-3"></i>
                        <h5 style="color: var(--text-secondary);">Пока нет товаров</h5>
                        <p style="color: var(--text-muted);">Добавьте свой первый товар!</p>
                        <a href="{{ url_for('add_product') }}" class="btn btn-primary">Добавить товар</a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
